/*! initmapjs - v0.1.0 - 2013-05-14
* https://github.com/jeromesmadja/initmapjs
* 2013 Jerome Smadja; Licensed DBAD */
(function(t){"use strict";function o(){var o,e=this;e.marker_collection=[],e.marker_promises={},e.init=function(n){var i=this[0],r={options:{center:new s(0,0).get(),zoom:2,mapTypeId:(new p).get("hybrid")}},a=!0;void 0!==n&&n.controls&&t.extend(r.options,new u(n.controls));var c=t.extend(!0,r,n);return o=e.initMap(i,r.options),c.geolocation&&(new d(o,c.geolocation,e.marker_collection).init(),c.geolocation.center===!0&&(a=!1)),c.center&&a===!0&&_.center(o,c.center),c.type&&o.setMapTypeId((new p).get(c.type)),c.markers&&e.markers.add(c.markers),e},e.initMap=function(t,o){return new m.Map(t,o)},e.getMap=function(){return o},e.markers={get:function(t,o){e.markers.exists(t)&&e.marker_collection[t].deferred.done(function(){o.call(this,e.marker_collection[t].marker)})},remove:function(t){e.markers.exists(t)&&e.marker_collection[t].deferred.done(function(){var o=e.marker_collection[t].marker;o.setMap(null),delete e.marker_collection[t]})},all:function(o){t.when(t.makeArray(e.marker_promises)).done(function(){o.call(e,e.marker_collection)})},add:function(s){t.map(s,function(s,p){e.marker_collection[p]={deferred:t.Deferred()};var c=new n(o,p,s,new i(o,new a),new r).place(e.marker_collection[p].deferred);e.marker_promises[p]=c,c.done(function(t){e.marker_collection[p]={deferred:c,marker:t}})})},exists:function(o){return void 0===e.marker_collection[o]&&t.error('Marker id "'+o+'" does not exist'),!0}}}function e(t){this.gGeocoder=m.Geocoder,this.position=t}function n(t,o,e,n,i){this.map=t,this.id=o,e!==void 0&&(this.options=void 0!==e.options?e.options:{},this.position=e.position,this.title=e.title,this.info_window=e.info_window,this.animation=e.animation),this.GMarker=m.Marker,this.Infowindow=n,this.Animation=i,void 0!==this.animation&&(this.options.animation=this.animate())}function i(t,o){this.GInfoWindow=m.InfoWindow,this.gEvent=o,this.map=t}function r(){this.GAnimation=m.Animation}function s(t,o,e){this.GLatLng=m.LatLng,this.lat=t,this.lng=o,this.nowrap=e}function a(){return m.event}function p(){this.map_type_id=m.MapTypeId}function c(o,e,n,i){var r={};return void 0!==o.position&&(r=n.get(o.position)),void 0!==o.type&&("object"==typeof o.type&&(t.map(o.type,function(t,n){o.type[n]=e.get(o.type[n])}),r.mapTypeIds=o.type),"string"==typeof o.type&&(r.mapTypeIds=[e.get(o.type)])),void 0!==o.style&&(r.style=i.get(o.style)),r}function l(){this.control_position=m.ControlPosition}function h(){this.control_style=m.MapTypeControlStyle}function f(){this.zoom_control_style=m.ZoomControlStyle}function d(t,o,e){this.map=t;var p=this;p.init=function(){if(p.has()){var t={};"object"==typeof o.options&&(t=o.options),navigator.geolocation.getCurrentPosition(p.set,p.error,t)}else p.error({message:"The browser doesn't support geolocation.",code:4})},p.has=function(){return navigator.geolocation!==void 0},p.set=function(t){var c=new s(t.coords.latitude,t.coords.longitude).get();o.center&&_.setCenter(p.map,c),o.marker&&(e.geolocation={marker:new n(p.map,"geolocation",o.marker,new i(p.map,new a),new r).createMarker(c)}),p.success(t)},p.error=function(e){"function"==typeof o.error&&o.error.call(t,e)},p.success=function(e){"function"==typeof o.success&&o.success.call(t,e)}}var m=google.maps;t.fn.initMap=function(){this.length||t.error('There is no element "'+this.selector+'"');var e=arguments,n=[];return this.each(function(){n.push((new o).init.apply(t(this),e))}),1===n.length&&(n[0].length=1,n=n[0]),n},e.prototype.getGeocode=function(){var o=t.Deferred();return(new this.gGeocoder).geocode({address:this.position},function(t,e){"OK"===e?o.resolve(t):o.reject(e)}),o.promise()},n.prototype={animate:function(){return this.Animation.start(this.animation)},infowindow:function(t,o){var e=this.Infowindow.add(t),n="click",i="click";"string"==typeof t.showOn&&(n=t.showOn),"string"==typeof t.hideOn&&(i=t.hideOn),this.Infowindow.attachMarker(o,n,e),this.Infowindow.close(o,i,e)},place:function(o){if("object"==typeof this.position){var n=new s(this.position[0],this.position[1]).get(),i=new this.GMarker(t.extend(this.options,{map:this.map,position:n}));o.resolve(i),this.setOptions(o,i)}if("string"==typeof this.position){var r=this;new e(r.position).getGeocode().done(function(e){var n=e[0].geometry.location,i=new r.GMarker(t.extend(r.options,{map:r.map,position:n}));o.resolve(i),r.setOptions(i)}).fail(function(t){o.reject(t)})}return o},createMarker:function(o){return new this.GMarker(t.extend(this.options,{map:this.map,position:o}))},setOptions:function(t){void 0!==this.info_window&&this.infowindow(this.map,this.info_window,t)}},i.prototype={add:function(t){if(void 0!==t){var o=new this.GInfoWindow(t);return"function"==typeof t.closeclick&&this.attachEvent(o,"closeclick",t),"function"==typeof t.content_changed&&this.attachEvent(o,"content_changed",t),"function"==typeof t.domready&&this.attachEvent(o,"domready",t),"function"==typeof t.position_changed&&this.attachEvent(o,"position_changed",t),"function"==typeof t.zindex_changed&&this.attachEvent(o,"zindex_changed",t),o}},attachEvent:function(t,o,e){var n=this.map;return this.gEvent.addListener(t,o,function(){e[o].call(t,n)}),t},attachMarker:function(t,o,e){var n=this.map;return this.gEvent.addListener(t,o,function(){e.open(n,t)}),t},close:function(t,o,e){this.gEvent.addListener(t,o,function(){e.close()})}},r.prototype={start:function(t){return"bounce"===t?this.GAnimation.BOUNCE:"drop"===t?this.GAnimation.DROP:!1},stop:function(t){t.setAnimation(null)}},s.prototype.get=function(){return new this.GLatLng(this.lat,this.lng,this.nowrap)},p.prototype.get=function(t){return"hybrid"===t?this.map_type_id.HYBRID:"satellite"===t?this.map_type_id.SATELLITE:"roadmap"===t?this.map_type_id.ROADMAP:this.map_type_id.TERRAIN};var u=function(t){var o={};return t.map_type&&("boolean"==typeof t.map_type&&(o.mapTypeControl=t.map_type),"object"==typeof t.map_type&&(o.mapTypeControlOptions=new c(t.map_type,new p,new l,new h))),void 0!==t.overview&&("boolean"==typeof t.overview&&(o.overviewMapControl=t.overview),"object"==typeof t.overview&&(o.overviewMapControl=!0,o.overviewMapControlOptions={opened:t.overview.opened})),void 0!==t.pan&&("boolean"==typeof t.pan&&(o.panControl=t.pan),"object"==typeof t.pan&&(o.panControlOptions=(new l).get(t.pan.position))),void 0!==t.rotate&&("boolean"==typeof t.rotate&&(o.rotateControl=t.rotate),"object"==typeof t.rotate&&(o.rotateControlOptions=(new l).get(t.rotate.position))),void 0!==t.scale&&("boolean"==typeof t.scale&&(o.scaleControl=t.scale),"object"==typeof t.scale&&(o.scaleControlOptions=(new l).get(t.scale.position))),void 0!==t.street_view&&("boolean"==typeof t.street_view&&(o.streetViewControl=t.street_view),"object"==typeof t.street_view&&(o.streetViewControlOptions=(new l).get(t.street_view.position))),void 0!==t.zoom&&("boolean"==typeof t.zoom&&(o.zoomControl=t.zoom),"object"==typeof t.zoom&&(o.zoomControlOptions=(new l).get(t.zoom.position))),o};l.prototype.get=function(t){return"bottom_center"===t?{position:this.control_position.BOTTOM_CENTER}:"bottom_left"===t?{position:this.control_position.BOTTOM_LEFT}:"bottom_right"===t?{position:this.control_position.BOTTOM_RIGHT}:"left_bottom"===t?{position:this.control_position.LEFT_BOTTOM}:"left_center"===t?{position:this.control_position.LEFT_CENTER}:"left_top"===t?{position:this.control_position.LEFT_TOP}:"right_bottom"===t?{position:this.control_position.RIGHT_BOTTOM}:"right_center"===t?{position:this.control_position.RIGHT_CENTER}:"right_top"===t?{position:this.control_position.RIGHT_TOP}:"top_center"===t?{position:this.control_position.TOP_CENTER}:"top_right"===t?{position:this.control_position.TOP_RIGHT}:{position:this.control_position.TOP_LEFT}},h.prototype.get=function(t){return"dropdown_menu"===t?this.control_style.DROPDOWN_MENU:"horizontal_bar"===t?this.control_style.HORIZONTAL_BAR:this.control_style.DEFAULT},f.prototype.get=function(t){return"large"===t?this.zoom_control_style.LARGE:"small"===t?this.zoom_control_style.SMALL:this.zoom_control_style.DEFAULT};var _={center:function(t,o,n){"string"==typeof o&&new e(o).getGeocode().done(function(o){_.setCenter(t,o[0].geometry.location,n)}),"object"==typeof o&&_.setCenter(t,new s(o[0],o[1]).get(),n)},setCenter:function(t,o,e){e!==void 0&&e?t.setCenter(o):t.panTo(o)}}})(jQuery);