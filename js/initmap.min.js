/*! initmapjs - v0.1.0 - 2013-05-11
* https://github.com/jeromesmadja/initmapjs
* 2013 Jerome Smadja; Licensed DBAD */
(function(t){"use strict";function o(){var o=this;o.marker_collection=[],o.marker_promises={},o.init=function(e){var n=this[0],i={options:{center:new s(0,0).get(),zoom:2,mapTypeId:(new c).get("hybrid")}};void 0!==e&&e.controls&&t.extend(i.options,new m(e.controls));var r=t.extend(!0,i,e);return u=o.initMap(n,i.options),r.center&&w.center(r.center),r.type&&u.setMapTypeId((new c).get(r.type)),r.markers&&o.markers.add(r.markers),r.geolocation&&new d(r.geolocation,o.marker_collection).init(),o},o.initMap=function(t,o){return new _.Map(t,o)},o.getMap=function(){return u},o.markers={get:function(t,e){o.markers.exists(t)&&o.marker_collection[t].deferred.done(function(){e.call(this,o.marker_collection[t].marker)})},remove:function(t){o.markers.exists(t)&&o.marker_collection[t].deferred.done(function(){var e=o.marker_collection[t].marker;e.setMap(null),delete o.marker_collection[t]})},all:function(e){t.when(t.makeArray(o.marker_promises)).done(function(){e.call(o,o.marker_collection)})},add:function(e){t.map(e,function(e,s){o.marker_collection[s]={deferred:t.Deferred()};var c=new n(s,e,new i(new a),new r).place(o.marker_collection[s].deferred);o.marker_promises[s]=c,c.done(function(t){o.marker_collection[s]={deferred:c,marker:t}})})},exists:function(e){return void 0===o.marker_collection[e]&&t.error('Marker id "'+e+'" does not exist'),!0}}}function e(t){this.gGeocoder=_.Geocoder,this.position=t}function n(t,o,e,n){this.id=t,o!==void 0&&(this.options=void 0!==o.options?o.options:{},this.position=o.position,this.title=o.title,this.info_window=o.info_window),this.GMarker=_.Marker,this.Infowindow=e,this.Animation=n,void 0!==this.options.animation&&(this.options.animation=this.animate())}function i(t){this.GInfoWindow=_.InfoWindow,this.gEvent=t}function r(){this.GAnimation=_.Animation}function s(t,o,e){this.GLatLng=_.LatLng,this.lat=t,this.lng=o,this.nowrap=e}function a(){return _.event}function c(){this.map_type_id=_.MapTypeId}function p(o,e,n,i){var r={};return void 0!==o.position&&(r=n.get(o.position)),void 0!==o.type&&("object"==typeof o.type&&(t.map(o.type,function(t,n){o.type[n]=e.get(o.type[n])}),r.mapTypeIds=o.type),"string"==typeof o.type&&(r.mapTypeIds=[e.get(o.type)])),void 0!==o.style&&(r.style=i.get(o.style)),r}function l(){this.control_position=_.ControlPosition}function f(){this.control_style=_.MapTypeControlStyle}function h(){this.zoom_control_style=_.ZoomControlStyle}function d(t,o){var e=this;e.init=function(){if(e.has()){var o={};"object"==typeof t.options&&(o=t.options),navigator.geolocation.getCurrentPosition(e.set,e.error,o)}else e.error({message:"The browser doesn't support geolocation.",code:4})},e.has=function(){return navigator.geolocation!==void 0},e.set=function(a){var c=new s(a.coords.latitude,a.coords.longitude).get();t.center&&w.setCenter(c,!1,!0),t.marker&&(o.geolocation={marker:new n("geolocation",t.marker,new i,new r).createMarker(c)}),e.success(a)},e.error=function(o){"function"==typeof t.error&&t.error.call(u,o)},e.success=function(o){"function"==typeof t.success&&t.success.call(u,o)}}var u,_=google.maps;t.fn.initMap=function(){this.length||t.error('There is no element "'+this.selector+'"');var e=arguments,n=[];return this.each(function(){n.push((new o).init.apply(t(this),e))}),1===n.length&&(n[0].length=1,n=n[0]),n},e.prototype.getGeocode=function(){var o=t.Deferred();return(new this.gGeocoder).geocode({address:this.position},function(t,e){"OK"===e?o.resolve(t):o.reject(e)}),o.promise()},n.prototype={animate:function(){return this.Animation.start(this.options.animation)},infowindow:function(t,o){var e=this.Infowindow.add(t),n="click",i="click";"string"==typeof t.showOn&&(n=t.showOn),"string"==typeof t.hideOn&&(i=t.hideOn),this.Infowindow.attachMarker(o,n,e),this.Infowindow.close(o,i,e)},place:function(o){if("object"==typeof this.position){var n=new s(this.position[0],this.position[1]).get(),i=new this.GMarker(t.extend(this.options,{map:u,position:n}));o.resolve(i),this.setOptions(o,i)}if("string"==typeof this.position){var r=this;new e(r.position).getGeocode().done(function(e){var n=e[0].geometry.location,i=new r.GMarker(t.extend(r.options,{map:u,position:n}));o.resolve(i),r.setOptions(i)}).fail(function(t){o.reject(t)})}return o},createMarker:function(o){return new this.GMarker(t.extend(this.options,{map:u,position:o}))},setOptions:function(t){void 0!==this.info_window&&this.infowindow(this.info_window,t)}},i.prototype={add:function(t){if(void 0!==t){var o=new this.GInfoWindow(t);return"function"==typeof t.closeclick&&this.attachEvent(o,"closeclick",t),"function"==typeof t.content_changed&&this.attachEvent(o,"content_changed",t),"function"==typeof t.domready&&this.attachEvent(o,"domready",t),"function"==typeof t.position_changed&&this.attachEvent(o,"position_changed",t),"function"==typeof t.zindex_changed&&this.attachEvent(o,"zindex_changed",t),o}},attachEvent:function(t,o,e){return this.gEvent.addListener(t,o,function(){e[o].call(t,u)}),t},attachMarker:function(t,o,e){return this.gEvent.addListener(t,o,function(){e.open(u,t)}),t},close:function(t,o,e){this.gEvent.addListener(t,o,function(){e.close()})}},r.prototype={start:function(t){return"bounce"===t?this.GAnimation.BOUNCE:"drop"===t?this.GAnimation.DROP:!1},stop:function(t){t.setAnimation(null)}},s.prototype.get=function(){return new this.GLatLng(this.lat,this.lng,this.nowrap)},c.prototype.get=function(t){return"hybrid"===t?this.map_type_id.HYBRID:"satellite"===t?this.map_type_id.SATELLITE:"roadmap"===t?this.map_type_id.ROADMAP:this.map_type_id.TERRAIN};var m=function(t){var o={};return t.map_type&&("boolean"==typeof t.map_type&&(o.mapTypeControl=t.map_type),"object"==typeof t.map_type&&(o.mapTypeControlOptions=new p(t.map_type,new c,new l,new f))),void 0!==t.overview&&("boolean"==typeof t.overview&&(o.overviewMapControl=t.overview),"object"==typeof t.overview&&(o.overviewMapControl=!0,o.overviewMapControlOptions={opened:t.overview.opened})),void 0!==t.pan&&("boolean"==typeof t.pan&&(o.panControl=t.pan),"object"==typeof t.pan&&(o.panControlOptions=(new l).get(t.pan.position))),void 0!==t.rotate&&("boolean"==typeof t.rotate&&(o.rotateControl=t.rotate),"object"==typeof t.rotate&&(o.rotateControlOptions=(new l).get(t.rotate.position))),void 0!==t.scale&&("boolean"==typeof t.scale&&(o.scaleControl=t.scale),"object"==typeof t.scale&&(o.scaleControlOptions=(new l).get(t.scale.position))),void 0!==t.street_view&&("boolean"==typeof t.street_view&&(o.streetViewControl=t.street_view),"object"==typeof t.street_view&&(o.streetViewControlOptions=(new l).get(t.street_view.position))),void 0!==t.zoom&&("boolean"==typeof t.zoom&&(o.zoomControl=t.zoom),"object"==typeof t.zoom&&(o.zoomControlOptions=(new l).get(t.zoom.position))),o};l.prototype.get=function(t){return"bottom_center"===t?{position:this.control_position.BOTTOM_CENTER}:"bottom_left"===t?{position:this.control_position.BOTTOM_LEFT}:"bottom_right"===t?{position:this.control_position.BOTTOM_RIGHT}:"left_bottom"===t?{position:this.control_position.LEFT_BOTTOM}:"left_center"===t?{position:this.control_position.LEFT_CENTER}:"left_top"===t?{position:this.control_position.LEFT_TOP}:"right_bottom"===t?{position:this.control_position.RIGHT_BOTTOM}:"right_center"===t?{position:this.control_position.RIGHT_CENTER}:"right_top"===t?{position:this.control_position.RIGHT_TOP}:"top_center"===t?{position:this.control_position.TOP_CENTER}:"top_right"===t?{position:this.control_position.TOP_RIGHT}:{position:this.control_position.TOP_LEFT}},f.prototype.get=function(t){return"dropdown_menu"===t?this.control_style.DROPDOWN_MENU:"horizontal_bar"===t?this.control_style.HORIZONTAL_BAR:this.control_style.DEFAULT},h.prototype.get=function(t){return"large"===t?this.zoom_control_style.LARGE:"small"===t?this.zoom_control_style.SMALL:this.zoom_control_style.DEFAULT};var y=!0,w={center:function(t,o){"string"==typeof t&&new e(t).getGeocode().done(function(t){w.setCenter(t[0].geometry.location,o)}),"object"==typeof t&&w.setCenter(new s(t[0],t[1]).get(),o)},setCenter:function(t,o,e){y!==!1&&(e&&(y=!1),o!==void 0&&o?u.setCenter(t):u.panTo(t))}}})(jQuery);